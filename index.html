<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bear House — Inventory & Billing (Local)</title>
  <style>
    :root{--accent:#2b6cb0;--muted:#666}
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f5f7fb;color:#111}
    header{background:linear-gradient(90deg,#1e3a8a,#2563eb);color:#fff;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:20px;letter-spacing:0.6px}
    main{padding:18px;max-width:1100px;margin:18px auto}
    .tabs{display:flex;gap:8px;margin-bottom:14px}
    .tab{padding:10px 14px;background:#fff;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.06);cursor:pointer}
    .tab.active{background:var(--accent);color:#fff}
    .panel{background:#fff;padding:16px;border-radius:8px;box-shadow:0 6px 20px rgba(2,6,23,0.06)}
    form.inline{display:flex;gap:8px;flex-wrap:wrap;align-items:end}
    form.inline label{display:block;font-size:12px;color:var(--muted)}
    .field{display:flex;flex-direction:column}
    input,select,button{padding:8px;border-radius:6px;border:1px solid #ddd;font-size:14px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;text-align:left;border-bottom:1px solid #eee;font-size:14px}
    .actions button{margin-right:6px}
    .billing-grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
    .search-suggestions{position:relative}
    .suggest-list{position:absolute;top:44px;left:0;right:0;background:#fff;border:1px solid #ddd;border-radius:6px;max-height:180px;overflow:auto;z-index:10}
    .suggest-list div{padding:8px;cursor:pointer}
    .suggest-list div:hover{background:#f3f4f6}
    .cart{background:#fafafa;padding:10px;border-radius:6px;min-height:120px}
    .cart-row{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:6px;border-bottom:1px dashed #eee}
    .warn{color:#b91c1c;font-weight:600}
    .sales-list{max-height:360px;overflow:auto}
    .receipt{width:280px;padding:10px;background:#fff;font-size:13px;line-height:1.3}
    .receipt h2{text-align:center;margin:4px 0}
    .receipt .items{margin-top:8px}
    .receipt .row{display:flex;justify-content:space-between}
    .receipt .small{font-size:12px}
    @media print{
      body *{visibility:hidden}
      #print-area, #print-area *{visibility:visible}
      #print-area{position:fixed;left:0;top:0}
    }
    .muted{color:var(--muted)}
    .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--accent);border:1px solid var(--accent)}
    .mismatch{border:2px solid #b91c1c !important}
  </style>
</head>
<body>
  <header>
    <h1>Bear House</h1>
    <div class="muted">Local (browser) • Saves to localStorage</div>
  </header>

  <main>
    <div class="tabs">
      <div class="tab active" data-tab="inventory">Inventory</div>
      <div class="tab" data-tab="billing">Billing</div>
      <div class="tab" data-tab="sales">Sales History</div>
    </div>

    <!-- Inventory -->
    <section class="panel" id="inventory-panel">
      <h3>Inventory — Add / Manage Products</h3>
      <form id="product-form" class="inline" onsubmit="return false">
        <div class="field" style="flex:2">
          <label>SKU</label>
          <input id="p-sku" required />
        </div>
        <div class="field" style="flex:2">
          <label>Product Name</label>
          <input id="p-name" required />
        </div>
        <div class="field">
          <label>Sale Price (MRP ₹)</label>
          <input id="p-mrp" type="number" min="0" step="0.01" required />
        </div>
        <div class="field">
          <label>Quantity</label>
          <input id="p-qty" type="number" min="0" step="1" required />
        </div>
        <div class="field">
          <label>Variant / Size (optional)</label>
          <input id="p-variant" placeholder="e.g. 300 ml, 1 L" />
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <button id="add-product" class="btn">Add / Update</button>
          <button id="clear-form" class="btn ghost" type="button">Clear</button>
          <button id="import-csv" class="btn ghost" type="button">Import CSV</button>
          <button id="export-csv" class="btn ghost" type="button">Export CSV</button>
        </div>
      </form>

      <table id="inventory-table">
        <thead><tr><th>#</th><th>SKU</th><th>Product</th><th>Variant</th><th>MRP</th><th>Qty</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Billing -->
    <section class="panel" id="billing-panel" style="display:none;margin-top:14px">
      <h3>Billing</h3>
      <div class="billing-grid">
        <div>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <div style="flex:1">
              <label class="muted">Search product</label>
              <div class="search-suggestions">
                <input id="search" placeholder="Type product name or SKU" autocomplete="off" />
                <div class="suggest-list" id="suggest" style="display:none"></div>
              </div>
            </div>
            <div style="width:120px">
              <label class="muted">Quantity</label>
              <input id="search-qty" type="number" min="1" value="1" />
            </div>
            <div style="width:120px;display:flex;flex-direction:column">
              <label class="muted">Add</label>
              <button id="add-to-cart" class="btn">Add to cart</button>
            </div>
          </div>
          <div id="not-inv" style="display:none" class="warn">Product not found in inventory or name mismatch!</div>
          <div class="cart" id="cart">
            <strong>Cart</strong>
            <div id="cart-rows"></div>
            <div id="cart-empty" class="muted">No items in cart</div>
          </div>
        </div>

        <aside>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <div style="flex:1">
              <label class="muted">Billing No.</label>
              <input id="bill-no" readonly />
            </div>
            <div style="width:160px">
              <label class="muted">Date & Time</label>
              <input id="bill-dt" readonly />
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-bottom:8px">
            <div style="flex:1">
              <label class="muted">Discount</label>
              <input id="discount" type="number" min="0" value="0" />
            </div>
            <div style="width:120px">
              <label class="muted">Type</label>
              <select id="disc-type"><option value="percent">%</option><option value="amount">₹</option></select>
            </div>
          </div>

          <div style="background:#fff;padding:8px;border-radius:6px;border:1px solid #eee">
            <div style="display:flex;justify-content:space-between"><div class="muted">Subtotal</div><div id="subtotal">₹0.00</div></div>
            <div style="display:flex;justify-content:space-between"><div class="muted">Discount</div><div id="disc-val">₹0.00</div></div>
            <hr />
            <div style="display:flex;justify-content:space-between;font-weight:700"><div>Total</div><div id="total">₹0.00</div></div>
            <div style="margin-top:8px;display:flex;gap:6px">
              <button id="finalize" class="btn">Finalize & Save</button>
              <button id="print" class="btn ghost">Print (Thermal)</button>
              <button id="clear-cart" class="btn ghost">Clear Cart</button>
            </div>
          </div>
        </aside>
      </div>

      <div id="print-area" style="display:none;margin-top:12px">
        <div class="receipt" id="receipt-template"></div>
      </div>
    </section>

    <!-- Sales -->
    <section class="panel" id="sales-panel" style="display:none;margin-top:14px">
      <h3>Sales History</h3>
      <div class="sales-list" id="sales-list"></div>
    </section>

  </main>

<script>
const INV_KEY = 'bearhouse_inventory';
const SALES_KEY = 'bearhouse_sales';
let inventory = [], cart = [], sales = [], editingId=null;

// DOM helpers
const $ = id => document.getElementById(id);

// LOAD DATA
function load(){
  inventory = JSON.parse(localStorage.getItem(INV_KEY)||'[]');
  sales = JSON.parse(localStorage.getItem(SALES_KEY)||'[]');
  renderInventory();
  renderSales();
  newBillMeta();
}

// SAVE INVENTORY
function saveInventory(){ localStorage.setItem(INV_KEY, JSON.stringify(inventory)); renderInventory(); }

// ADD / UPDATE PRODUCT
function addOrUpdateProduct(){
  const sku = $('p-sku').value.trim();
  const name = $('p-name').value.trim();
  const mrp = parseFloat($('p-mrp').value)||0;
  const qty = parseInt($('p-qty').value)||0;
  const variant = $('p-variant').value.trim();
  if(!sku || !name) return alert('Enter SKU and product name');

  const existing = inventory.find(p=>p.sku===sku);
  if(existing){
    if(existing.name!==name){
      $('p-name').classList.add('mismatch');
      return alert('SKU exists but product name does not match!');
    } else {
      existing.qty += qty; existing.mrp = mrp; existing.variant = variant; editingId=null;
    }
  } else {
    inventory.push({id:'p_'+Date.now(),sku,name,mrp,qty,variant});
  }
  $('p-name').classList.remove('mismatch');
  saveInventory(); clearForm();
}

// CLEAR FORM
function clearForm(){ ['p-sku','p-name','p-mrp','p-qty','p-variant'].forEach(id=>$(id).value=''); editingId=null; $('add-product').textContent='Add / Update'; }

// RENDER INVENTORY
function renderInventory(){
  const tbody = $('inventory-table').querySelector('tbody'); tbody.innerHTML='';
  inventory.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${p.sku}</td><td>${p.name}</td><td>${p.variant||'—'}</td><td>₹${p.mrp.toFixed(2)}</td><td>${p.qty}</td>
      <td class="actions">
        <button onclick="editProduct('${p.id}')">Edit</button>
        <button onclick="deleteProduct('${p.id}')">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

// EDIT / DELETE
function editProduct(id){ const p=inventory.find(x=>x.id===id); if(!p) return; $('p-sku').value=p.sku; $('p-name').value=p.name; $('p-mrp').value=p.mrp; $('p-qty').value=p.qty; $('p-variant').value=p.variant||''; editingId=id; $('add-product').textContent='Update Product'; }
function deleteProduct(id){ if(!confirm('Delete this product?')) return; inventory=inventory.filter(x=>x.id!==id); saveInventory(); }

// SEARCH & SUGGESTIONS
$('search').addEventListener('input', function(){
  const q=this.value.trim().toLowerCase();
  const suggest=$('suggest'); suggest.innerHTML='';
  if(!q){ suggest.style.display='none'; return; }
  const matches = inventory.filter(p=>p.name.toLowerCase().includes(q)||p.sku.toLowerCase().includes(q));
  if(matches.length===0){ suggest.style.display='none'; return; }
  matches.forEach(p=>{
    const d=document.createElement('div');
    d.textContent=`${p.name} (${p.sku}) — ₹${p.mrp} | Stock:${p.qty}`;
    d.onclick=()=>{ $('search').value=p.sku; suggest.style.display='none'; $('not-inv').style.display='none'; };
    suggest.appendChild(d);
  });
  suggest.style.display='block';
});
document.addEventListener('click', e=>{ if(!e.target.closest('.search-suggestions')) $('suggest').style.display='none'; });

// CART FUNCTIONS
function addToCart(){
  const input=$('search').value.trim();
  const qty=parseInt($('search-qty').value)||1;
  const product=inventory.find(p=>p.sku===input);
  if(!product){ $('not-inv').style.display='block'; return; } $('not-inv').style.display='none';
  const c = cart.find(i=>i.sku===product.sku);
  if(c){ c.qty+=qty; } else cart.push({...product,qty});
  renderCart(); $('search').value=''; $('search-qty').value=1;
}
function renderCart(){
  const container=$('cart-rows'); container.innerHTML='';
  if(cart.length===0){ $('cart-empty').style.display='block'; $('subtotal').textContent='₹0.00'; $('disc-val').textContent='₹0.00'; $('total').textContent='₹0.00'; return; }
  $('cart-empty').style.display='none';
  let subtotal=0;
  cart.forEach((c,i)=>{
    const div=document.createElement('div'); div.className='cart-row';
    div.innerHTML=`<div>${c.name} (${c.sku}) x ${c.qty}</div><div>₹${(c.mrp*c.qty).toFixed(2)} <button onclick="removeCart(${i})">❌</button></div>`;
    container.appendChild(div); subtotal+=c.mrp*c.qty;
  });
  $('subtotal').textContent=`₹${subtotal.toFixed(2)}`;
  const disc=parseFloat($('discount').value)||0;
  const discVal=$('disc-type').value==='percent'?subtotal*(disc/100):disc;
  $('disc-val').textContent=`₹${discVal.toFixed(2)}`;
  $('total').textContent=`₹${(subtotal-discVal).toFixed(2)}`;
}
function removeCart(idx){ cart.splice(idx,1); renderCart(); }
function clearCart(){ if(!confirm('Clear cart?')) return; cart=[]; renderCart(); }

// FINALIZE BILL
function newBillMeta(){ $('bill-no').value='BH-'+Date.now().toString(36).toUpperCase().slice(-8); $('bill-dt').value=new Date().toLocaleString(); $('discount').value=0; $('disc-type').value='percent'; cart=[]; renderCart(); }
function finalizeBill(){
  if(cart.length===0) return alert('Cart empty'); 
  cart.forEach(c=>{ const p=inventory.find(x=>x.sku===c.sku); if(p) p.qty=Math.max(0,p.qty-c.qty); });
  saveInventory();
  const subtotal=cart.reduce((s,i)=>s+i.mrp*i.qty,0); const disc=parseFloat($('discount').value)||0;
  const discVal=$('disc-type').value==='percent'?subtotal*(disc/100):disc;
  const total=+(subtotal-discVal).toFixed(2);
  const sale={id:$('bill-no').value, dt:new Date().toISOString(), items:cart.map(i=>({name:i.name,sku:i.sku,qty:i.qty,mrp:i.mrp})),subtotal,discVal,total};
  sales.unshift(sale); localStorage.setItem(SALES_KEY,JSON.stringify(sales));
  renderSales(); generateReceipt(sale); newBillMeta();
}

// SALES HISTORY
function renderSales(){
  const container=$('sales-list'); container.innerHTML='';
  if(sales.length===0){ container.innerHTML='<div class="muted">No sales yet</div>'; return; }
  sales.forEach(s=>{
    const d=document.createElement('div'); d.style.borderBottom='1px dashed #ccc'; d.style.padding='6px 0';
    d.innerHTML=`<div><strong>${s.id}</strong> | ${new Date(s.dt).toLocaleString()}</div>
      <div>Total: ₹${s.total.toFixed(2)} | Items: ${s.items.length}</div>`;
    container.appendChild(d);
  });
}

// RECEIPT
function generateReceipt(sale){
  const r=$('receipt-template'); r.innerHTML=`<h2>Bear House</h2><div>Date: ${new Date(sale.dt).toLocaleString()}</div>
    <div class="items">${sale.items.map(i=>`<div class="row"><span>${i.name} x ${i.qty}</span><span>₹${(i.mrp*i.qty).toFixed(2)}</span></div>`).join('')}</div>
    <hr/><div class="row"><span>Subtotal</span><span>₹${sale.subtotal.toFixed(2)}</span></div>
    <div class="row"><span>Discount</span><span>₹${sale.discVal.toFixed(2)}</span></div>
    <div class="row"><strong>Total</strong><strong>₹${sale.total.toFixed(2)}</strong></div>`;
}

// PRINT THERMAL
function printReceipt(){ window.print(); }

// TAB SWITCH
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    $('inventory-panel').style.display='none';
    $('billing-panel').style.display='none';
    $('sales-panel').style.display='none';
    const tab=t.getAttribute('data-tab');
    $(tab+'-panel').style.display='block';
  };
});

// --- BUTTON EVENTS ---
$('add-product').onclick=addOrUpdateProduct;
$('clear-form').onclick=clearForm;
$('add-to-cart').onclick=addToCart;
$('clear-cart').onclick=clearCart;
$('finalize').onclick=finalizeBill;
$('print').onclick=printReceipt;

// --- IMPORT / EXPORT CSV ---
$('export-csv').onclick=exportCSV;
$('import-csv').onclick=importCSV;

// EXPORT CSV
function exportCSV(){
  if(inventory.length===0) return alert('No inventory to export');
  const rows=[['SKU','Name','Variant','MRP','Qty'], ...inventory.map(p=>[p.sku,p.name,p.variant||'',p.mrp,p.qty])];
  const csvContent = rows.map(r => r.map(v => `"${v}"`).join(',')).join('\n');
  const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'inventory.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// IMPORT CSV
function importCSV(){
  const inp=document.createElement('input');
  inp.type='file'; inp.accept='.csv';
  inp.addEventListener('change', ()=>{
    const file = inp.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const text = e.target.result.split('\n').map(r=>r.replace(/"/g,'').trim()).filter(r=>r);
      if(text.length<2) return alert('CSV is empty or invalid');
      const headers = text.shift().split(',').map(h=>h.trim().toLowerCase());
      text.forEach(row=>{
        const vals = row.split(',');
        if(vals.length<5) return;
        const obj = {
          id: 'p_' + Date.now() + Math.random().toString(36).slice(2,6),
          sku: vals[0].trim(),
          name: vals[1].trim(),
          variant: vals[2].trim(),
          mrp: parseFloat(vals[3]) || 0,
          qty: parseInt(vals[4]) || 0
        };
        const exist = inventory.find(p=>p.sku===obj.sku);
        if(exist){
          exist.qty += obj.qty;
          exist.mrp = obj.mrp;
          exist.name = obj.name;
          exist.variant = obj.variant;
        } else inventory.push(obj);
      });
      saveInventory();
      alert('CSV imported successfully!');
    };
    reader.readAsText(file);
  });
  inp.click();
}

load();
</script>
</body>
</html>
